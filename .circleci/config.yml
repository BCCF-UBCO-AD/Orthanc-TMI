version: 2.1

jobs:
  google-test:
    machine:
      image: ubuntu-1604:202004-01
    steps:
      - checkout
      - run:
          name: Environment Setup
          command: |
            sudo apt-get install gcc
            sudo apt purge --auto-remove cmake
            cd /temp
            wget https://github.com/Kitware/CMake/releases/download/v3.20.0/cmake-3.20.0.tar.gz
            tar -zxvf cmake-3.20.0.tar.gz
            cd cmake-3.20.0
            ./bootstrap
            make
            sudo make install
            echo 'Environment setup complete'

      - run:
          name: Build with CMake
          command: |
            mkdir build
            cd build
            cmake ..
            make
            echo 'Build complete'
          
      - run:
          name: Run googletest suite
          command: |
            ./Orthanc-TMI-tests --gtest_ouput="xml"
            echo 'Tests run complete'

workflows:
  version: 2
  GoogleTest:
    jobs:
      - google-test