  on:
    pull_request:
      branches:
        - master
        - develop

  env:
    BUILD_TYPE: Debug

  jobs:
    Orthanc-TMI:
      runs-on: ubuntu-20.04
      steps:
        - name: Clone Orthanc-TMI
          uses: actions/checkout@v2
          with:
            submodules: true
        - name: Install dependencies
          run: |
            sudo apt install -y software-properties-common lsb-release
            sudo apt-get install \
              gcc \
              ninja-build \
              cmake \
              postgresql \
              postgresql-contrib \
              libpq5 \
              libpq-dev
        - name: Build
          run: |
            cmake \
              -S . \
              -B build \
              -G Ninja
            ninja -C build DataAnonymizer
            ninja -C build Orthanc-TMI-tests
        - name: Launch Docker
          run: |
            docker-compose down
            docker-compose up -d && sleep 5s
#        - name: Check Docker Status
#          run: |
#            status=$(docker ps --all --filter name=orthanc-server --format '{{.Status}}')
#            echo Orthanc Docker Container: $status
#            if echo $status | grep Up &>/dev/null; then :; else docker logs orthanc-server && exit 1; fi
        - name: Run Unit Tests
          run: |
            build/Orthanc-TMI-tests --gtest_output=xml:build/
