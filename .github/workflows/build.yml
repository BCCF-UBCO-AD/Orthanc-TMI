  on:
    pull_request:
      branches:
        - master
        - develop
        - feat-filter
        - feat-phi
    workflow_dispatch:

  env:
    BUILD_TYPE: Debug

  jobs:
    Orthanc-TMI:
      runs-on: ubuntu-20.04
      steps:
        - name: Install dependencies
          run: |
            sudo apt-get update
            echo "update done";echo
            sudo apt-get install -y software-properties-common lsb-release
            echo;echo
            sudo apt-get install \
              postgresql \
              postgresql-contrib
            echo "postgresql packages installed";echo
            sudo apt-get install \
              gcc \
              ninja-build \
              cmake \
              libpq5 \
              libpq-dev
        - name: Clone Orthanc-TMI
          uses: actions/checkout@v2
          with:
            submodules: true
        - name: Build
          run: |
            cmake \
              -DCMAKE_BUILD_TYPE=Release \
              -S . \
              -B build/release \
              -G Ninja
            cmake \
              -DCMAKE_BUILD_TYPE=Debug \
              -S . \
              -B build/debug \
              -G Ninja
            ninja -C build/release data-anonymizer
            ninja -C build/debug all-tests
        - name: Initialize PostgreSQL
          run: | 
            cd .github
            docker-compose up -d postgres && sleep 60s
            docker logs --details postgres
            docker-compose down && sleep 10s
        - name: Launch Docker Compose
          run: |
            cd .github
            docker-compose up -d && sleep 25s
        - name: Check PostgreSQL
          run: |
            status=$(docker ps --all --filter name=postgres --format '{{.Status}}')
            echo PostgreSQL Docker Container: $status
            if echo $status | grep Up &>/dev/null; then :; else docker logs --details postgres && exit 1; fi
        - name: Check Docker Status
          run: |
            status=$(docker ps --all --filter name=orthanc-server --format '{{.Status}}')
            echo Orthanc Docker Container: $status
            if echo $status | grep Up &>/dev/null; then :; else docker logs --details orthanc-server && exit 1; fi
        - name: Run Unit Tests
          run: |
            build/debug/bin/all-tests --gtest_output=xml:build/
